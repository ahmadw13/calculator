name: Live Preview (Commit)

# TRIGGER: Runs on ANY push to ANY branch
on:
  push:
    branches:
      - '**'

permissions:
  contents: write # Required to post comments on commits

jobs:
  build-and-preview:
    name: Build & Preview
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      # Build Release APK
      - name: üî® Build APK
        run: flutter build apk --release

      # --- NEW STEP: Use the Official Action ---
      - name: üì± Upload to Appetize
        id: appetize # ID is important so we can read the output later
        uses: appetizeio/github-action-appetize@v1.0.5
        with:
          apiToken: ${{ secrets.APPETIZE_TOKEN }}
          appFile: "build/app/outputs/flutter-apk/app-release.apk"
          platform: "android"
          note: "Commit: ${{ github.sha }}"

      # --- COMMENT STEP ---
      - name: üí¨ Post Preview Link
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # We get the PublicKey from the previous step using 'steps.appetize.outputs.publicKey'
          PUBLIC_KEY: ${{ steps.appetize.outputs.publicKey }}
        run: |
          # Construct the link
          PREVIEW_URL="https://appetize.io/embed/$PUBLIC_KEY?device=pixel7&scale=75&autoplay=true&orientation=portrait&osVersion=13.0"
          
          echo "‚úÖ Link Generated: $PREVIEW_URL"

          # Post Comment to Commit
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="### üì± Mobile Preview Ready
            **Branch:** \`${{ github.ref_name }}\`
            
            [**‚ñ∂Ô∏è Click here to Test this Commit**]($PREVIEW_URL)"
