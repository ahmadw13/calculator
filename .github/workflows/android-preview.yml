name: Medical App Live Test

on:
  push:
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      - name: üî® Build APK
        run: flutter build apk --release

      # --- RENAME STEP (Fixed) ---
      - name: üè∑ Rename APK
        id: rename
        run: |
          # 1. Get Repo Name (App Name) and Clean Branch Name
          REPO_NAME="${{ github.event.repository.name }}"
          SAFE_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          
          # 2. Define filenames
          # Input: Standard Flutter output
          OLD_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          # Output: repoName_branchName.apk
          NEW_FILENAME="${REPO_NAME}_${SAFE_BRANCH}.apk"
          NEW_PATH="build/app/outputs/flutter-apk/$NEW_FILENAME"
          
          # 3. Rename the file
          mv $OLD_PATH $NEW_PATH
          
          echo "‚úÖ Renamed APK to: $NEW_FILENAME"
          
          # 4. Save variables for the next step
          echo "apk_path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "custom_id=${REPO_NAME}_${SAFE_BRANCH}" >> $GITHUB_OUTPUT

      # --- UPLOAD STEP (BrowserStack) ---
      - name: ‚òÅÔ∏è Upload to BrowserStack API
        id: browserstack
        env:
          BS_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          APK_PATH: ${{ steps.rename.outputs.apk_path }}
          CUSTOM_ID: ${{ steps.rename.outputs.custom_id }}
        run: |
          echo "üöÄ Uploading file: $APK_PATH"
          echo "üè∑  Target Custom ID: $CUSTOM_ID"

          # Upload via API
          # We force the 'custom_id' so BrowserStack overwrites the previous build for this branch
          RESPONSE=$(curl -u "$BS_USER:$BS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-live/upload" \
            -F "file=@$APK_PATH" \
            -F "data={\"custom_id\": \"$CUSTOM_ID\"}")

          APP_URL=$(echo $RESPONSE | jq -r .app_url)

          if [ "$APP_URL" == "null" ] || [ -z "$APP_URL" ]; then
            echo "‚ùå Upload Failed!"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Upload Success!"
          echo "dashboard_url=https://app-live.browserstack.com/dashboard" >> $GITHUB_OUTPUT
          echo "app_name=$CUSTOM_ID" >> $GITHUB_OUTPUT

      # --- OPTIONAL: Standard Artifact Upload (To download from GitHub) ---
      - name: üì¶ Store Artifact on GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.rename.outputs.custom_id }}
          path: ${{ steps.rename.outputs.apk_path }}

      - name: üí¨ Post Link to Commit
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DASHBOARD_LINK: ${{ steps.browserstack.outputs.dashboard_url }}
          APP_NAME: ${{ steps.browserstack.outputs.app_name }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="### üè• Medical App Build Ready
            **Branch:** \`${{ github.ref_name }}\`
            **File:** \`${APP_NAME}.apk\`
            
            The build is live on BrowserStack.
            
            1. [**Go to BrowserStack Dashboard**]($DASHBOARD_LINK)
            2. Select App: **\`$APP_NAME\`**"