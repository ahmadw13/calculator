name: BrowserStack Upload

on:
  push:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: üì¶ Get Dependencies
        run: flutter pub get

      - name: üî® Build APK
        run: flutter build apk --release

      - name: ‚òÅÔ∏è Upload to BrowserStack API
        id: browserstack
        env:
          BS_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "üöÄ Uploading Branch: $BRANCH_NAME..."
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          CUSTOM_ID="MedicalApp_$SAFE_BRANCH"
          
          RESPONSE=$(curl -u "$BS_USER:$BS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-live/upload" \
            -F "file=@build/app/outputs/flutter-apk/app-release.apk" \
            -F "data={\"custom_id\": \"$CUSTOM_ID\"}")

          APP_URL=$(echo $RESPONSE | jq -r .app_url)
          
          if [ "$APP_URL" == "null" ] || [ -z "$APP_URL" ]; then
            echo "‚ùå Upload Failed!"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Upload Success!"
          echo "dashboard_url=https://app-live.browserstack.com/dashboard" >> $GITHUB_OUTPUT
          echo "app_name=$CUSTOM_ID" >> $GITHUB_OUTPUT

      - name: üí¨ Post Link to Commit
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DASHBOARD_LINK: ${{ steps.browserstack.outputs.dashboard_url }}
          APP_NAME: ${{ steps.browserstack.outputs.app_name }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            -f body="### üè• Medical App Build Ready
            **Branch:** \`${{ github.ref_name }}\`
            
            The build is ready on BrowserStack App Live.
            
            1. [**Go to BrowserStack Dashboard**]($DASHBOARD_LINK)
            2. Select App: **\`$APP_NAME\`**"